# å­—å¹•æœç´¢ç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€å¯æ‰©å±•çš„å­—å¹•æœç´¢ç³»ç»Ÿï¼Œæ”¯æŒåœ¨å†…å­˜ä¸­å­˜å‚¨å’Œæ£€ç´¢è§†é¢‘å­—å¹•æ•°æ®ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
src/lib/
â”œâ”€â”€ types/subtitle.ts           # æ•°æ®ç±»å‹å®šä¹‰
â”œâ”€â”€ parsers/srt-parser.ts       # SRT æ–‡ä»¶è§£æå™¨
â”œâ”€â”€ storage/memory-store.ts     # å†…å­˜å­˜å‚¨ç®¡ç†å™¨
â”œâ”€â”€ services/subtitle-search-service.ts  # æœç´¢æœåŠ¡
â””â”€â”€ init/startup.ts             # åº”ç”¨åˆå§‹åŒ–
```

## ğŸ“Š æ•°æ®ç»“æ„

### SubtitleEntryï¼ˆå°è¯æ¡ç›®ï¼‰

```typescript
interface SubtitleEntry {
  id: string; // å”¯ä¸€æ ‡è¯†ç¬¦
  videoId: string; // è§†é¢‘ID
  sequenceNumber: number; // åºå·
  startTime: number; // å¼€å§‹æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  endTime: number; // ç»“æŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  text: string; // åŸå§‹æ–‡æœ¬
  normalizedText: string; // æ ‡å‡†åŒ–æ–‡æœ¬ï¼ˆç”¨äºæœç´¢ï¼‰
  duration: number; // æŒç»­æ—¶é—´
}
```

### VideoSubtitleï¼ˆè§†é¢‘å­—å¹•ï¼‰

```typescript
interface VideoSubtitle {
  videoId: string;
  entries: SubtitleEntry[];
}
```

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. SRT æ–‡ä»¶è§£æ

- è‡ªåŠ¨è§£æ `data/subtitles/` ç›®å½•ä¸‹çš„æ‰€æœ‰ `.srt` æ–‡ä»¶
- æ”¯æŒæ ‡å‡† SRT æ ¼å¼
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- æ—¶é—´æ ¼å¼è½¬æ¢ï¼ˆHH:MM:SS,mmm â†’ æ¯«ç§’ï¼‰

### 2. å†…å­˜å­˜å‚¨

- **ä¸»å­˜å‚¨**: `Map<string, SubtitleEntry>` - æŒ‰ ID å­˜å‚¨æ¡ç›®
- **è§†é¢‘ç´¢å¼•**: `Map<string, VideoSubtitle>` - æŒ‰è§†é¢‘ ID å­˜å‚¨
- **æ–‡æœ¬ç´¢å¼•**: `Map<string, Set<string>>` - å•è¯åˆ°æ¡ç›® ID çš„æ˜ å°„
- **ç»Ÿè®¡ä¿¡æ¯**: æ€»æ¡ç›®æ•°ã€è§†é¢‘æ•°ã€ç´¢å¼•è¯æ•°ç­‰

### 3. æœç´¢åŠŸèƒ½

- **ç²¾ç¡®åŒ¹é…**: å®Œå…¨åŒ¹é…æŸ¥è¯¢è¯
- **åŒ…å«åŒ¹é…**: éƒ¨åˆ†åŒ¹é…å’ŒåŒ…å«å…³ç³»
- **å¤šè¯æœç´¢**: AND é€»è¾‘ï¼ˆæ‰€æœ‰è¯éƒ½å¿…é¡»åŒ¹é…ï¼‰
- **ç›¸å…³æ€§æ’åº**: åŸºäºåŒ¹é…ç¨‹åº¦å’Œæ–‡æœ¬é•¿åº¦

### 4. é«˜çº§åŠŸèƒ½

- **æœç´¢å»ºè®®**: åŸºäºç°æœ‰å†…å®¹çš„è‡ªåŠ¨å®Œæˆ
- **è§†é¢‘è¿‡æ»¤**: é™åˆ¶æœç´¢èŒƒå›´åˆ°ç‰¹å®šè§†é¢‘
- **åˆ†é¡µæ”¯æŒ**: limit å’Œ offset å‚æ•°
- **æ€§èƒ½ä¼˜åŒ–**: é«˜æ•ˆçš„å†…å­˜ç´¢å¼•å’Œæœç´¢ç®—æ³•

## ğŸ”Œ API æ¥å£

### æœç´¢ API

```bash
# GET æ–¹å¼æœç´¢
GET /api/search?q=hello&limit=10&offset=0

# POST æ–¹å¼æœç´¢ï¼ˆæ”¯æŒæ›´å¤æ‚çš„å‚æ•°ï¼‰
POST /api/search
{
  "query": "hello",
  "options": {
    "limit": 10,
    "fuzzy": true,
    "videoIds": ["BV1JG4y1g76F"]
  }
}
```

### è·å–è§†é¢‘å­—å¹•

```bash
GET /api/subtitles/BV1JG4y1g76F
```

### æœç´¢å»ºè®®

```bash
GET /api/suggestions?q=good&limit=5
```

### ç³»ç»ŸçŠ¶æ€

```bash
GET /api/status
```

## ğŸ› ï¸ ä½¿ç”¨æ–¹æ³•

### 1. æ”¾ç½® SRT æ–‡ä»¶

å°† SRT æ–‡ä»¶æ”¾åœ¨ `data/subtitles/` ç›®å½•ä¸‹ï¼Œå»ºè®®ä½¿ç”¨è§†é¢‘ ID ä½œä¸ºæ–‡ä»¶åï¼š

```
data/subtitles/
â”œâ”€â”€ BV1JG4y1g76F.srt
â”œâ”€â”€ BV1fK6RYZEkd.srt
â””â”€â”€ BV1Bj421976y.srt
```

### 2. ç³»ç»Ÿè‡ªåŠ¨åˆå§‹åŒ–

ç³»ç»Ÿä¼šåœ¨é¦–æ¬¡ API è¯·æ±‚æ—¶è‡ªåŠ¨åˆå§‹åŒ–ï¼š

- è§£ææ‰€æœ‰ SRT æ–‡ä»¶
- å»ºç«‹å†…å­˜ç´¢å¼•
- å‡†å¤‡æœç´¢æœåŠ¡

### 3. ä½¿ç”¨æœç´¢åŠŸèƒ½

```javascript
// å‰ç«¯è°ƒç”¨ç¤ºä¾‹
const searchResults = await fetch("/api/search?q=hello&limit=10").then((res) =>
  res.json()
);

console.log(searchResults.data.results);
```

## ğŸ¯ æ‰©å±•æ€§è®¾è®¡

### æ•°æ®åº“è¿ç§»å‡†å¤‡

ç³»ç»Ÿè®¾è®¡æ—¶è€ƒè™‘äº†å°†æ¥è¿ç§»åˆ°æ•°æ®åº“çš„éœ€æ±‚ï¼š

1. **æŠ½è±¡æ¥å£**: æ‰€æœ‰å­˜å‚¨æ“ä½œéƒ½é€šè¿‡æœåŠ¡å±‚æŠ½è±¡
2. **æ ‡å‡†åŒ–æ•°æ®ç»“æ„**: æ•°æ®æ ¼å¼ä¸ SQL/NoSQL å…¼å®¹
3. **ç´¢å¼•ç­–ç•¥**: å†…å­˜ç´¢å¼•å¯ç›´æ¥æ˜ å°„åˆ°æ•°æ®åº“ç´¢å¼•
4. **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡æ’å…¥å’Œæ›´æ–°

### å‘é‡æ•°æ®åº“é›†æˆ

ä¸ºå°†æ¥æ”¯æŒè¯­ä¹‰æœç´¢ï¼Œå¯ä»¥æ‰©å±•æ•°æ®ç»“æ„ï¼š

```typescript
interface SubtitleEntry {
  // ... ç°æœ‰å­—æ®µ
  embedding?: number[]; // å‘é‡åµŒå…¥
  semanticTags?: string[]; // è¯­ä¹‰æ ‡ç­¾
}
```

### æ€§èƒ½ä¼˜åŒ–

- **æ‡’åŠ è½½**: å¤§æ–‡ä»¶åˆ†æ‰¹å¤„ç†
- **ç¼“å­˜ç­–ç•¥**: çƒ­é—¨æœç´¢ç»“æœç¼“å­˜
- **å¹¶è¡Œå¤„ç†**: å¤šæ–‡ä»¶å¹¶è¡Œè§£æ
- **å†…å­˜ç®¡ç†**: å¯é…ç½®çš„å†…å­˜ä½¿ç”¨é™åˆ¶

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

å½“å‰å†…å­˜å­˜å‚¨çš„æ€§èƒ½è¡¨ç°ï¼š

- **åˆå§‹åŒ–æ—¶é—´**: ~100msï¼ˆå–å†³äºæ–‡ä»¶å¤§å°ï¼‰
- **æœç´¢å“åº”æ—¶é—´**: <10msï¼ˆå•è¯æœç´¢ï¼‰
- **å†…å­˜ä½¿ç”¨**: ~1MB/1000 æ¡å­—å¹•
- **å¹¶å‘æ”¯æŒ**: æ— é”è®¾è®¡ï¼Œæ”¯æŒé«˜å¹¶å‘è¯»å–

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
node scripts/test-subtitle-system.js
```

æµ‹è¯•åŒ…æ‹¬ï¼š

- SRT æ–‡ä»¶è§£æ
- å†…å­˜å­˜å‚¨åˆå§‹åŒ–
- æœç´¢åŠŸèƒ½éªŒè¯
- å»ºè®®åŠŸèƒ½æµ‹è¯•

## ğŸ”§ é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡

```bash
# å­—å¹•æ–‡ä»¶ç›®å½•ï¼ˆå¯é€‰ï¼Œé»˜è®¤: data/subtitlesï¼‰
SUBTITLES_DIR=./custom/subtitles

# æœç´¢ç»“æœé»˜è®¤é™åˆ¶ï¼ˆå¯é€‰ï¼Œé»˜è®¤: 20ï¼‰
DEFAULT_SEARCH_LIMIT=50
```

### æœç´¢å‚æ•°

```typescript
interface SearchOptions {
  query: string; // æœç´¢æŸ¥è¯¢
  videoIds?: string[]; // è§†é¢‘IDè¿‡æ»¤
  limit?: number; // ç»“æœæ•°é‡é™åˆ¶
  offset?: number; // åˆ†é¡µåç§»
}
```

## ğŸ“ å¼€å‘è¯´æ˜

### æ·»åŠ æ–°çš„è§£æå™¨

1. åœ¨ `src/lib/parsers/` åˆ›å»ºæ–°çš„è§£æå™¨
2. å®ç° `parseFile()` æ–¹æ³•è¿”å› `VideoSubtitle`
3. åœ¨ `SubtitleSearchService` ä¸­é›†æˆ

### æ‰©å±•æœç´¢åŠŸèƒ½

1. åœ¨ `MemoryStore` ä¸­æ·»åŠ æ–°çš„ç´¢å¼•ç»“æ„
2. å®ç°ç›¸åº”çš„æœç´¢é€»è¾‘
3. æ›´æ–° `SearchOptions` æ¥å£

### æ•°æ®åº“è¿ç§»

1. åˆ›å»ºæ–°çš„å­˜å‚¨é€‚é…å™¨å®ç°ç›¸åŒæ¥å£
2. æ›´æ–° `SubtitleSearchService` ä½¿ç”¨æ–°é€‚é…å™¨
3. ä¿æŒ API æ¥å£ä¸å˜

è¿™ä¸ªç³»ç»Ÿä¸ºä½ çš„åº”ç”¨æä¾›äº†å¼ºå¤§çš„å­—å¹•æœç´¢èƒ½åŠ›ï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„æ‰©å±•æ€§ï¼Œä¾¿äºå°†æ¥é›†æˆæ›´é«˜çº§çš„åŠŸèƒ½ã€‚
